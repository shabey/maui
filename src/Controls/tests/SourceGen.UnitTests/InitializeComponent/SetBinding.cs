using System.Linq;
using NUnit.Framework;

namespace Microsoft.Maui.Controls.SourceGen.UnitTests;
public class SetBinding : SourceGenXamlInitializeComponentTestBase
{
	[Test]
	public void Test()
	{
		var xaml =
"""
<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
	xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
	xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
	x:Class="Test.TestPage" 
    Title="{Binding Title}"/>
""";

		var code =
"""
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
{
	public TestPage()
	{
		InitializeComponent();
	}
}
""";

		var expected =
"""

//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a .NET MAUI source generator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
#nullable enable

namespace Test;

[global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.Maui.Controls.SourceGen, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null", "1.0.0.0")]
public partial class TestPage
{
	private partial void InitializeComponentSourceGen()
	{
		var bindingExtension0 = new global::Microsoft.Maui.Controls.Xaml.BindingExtension();
		global::Test.TestPage __root = this;
		var nameScope0 = global::Microsoft.Maui.Controls.Internals.NameScope.GetNameScope(__root) ?? new global::Microsoft.Maui.Controls.Internals.NameScope();
		global::Microsoft.Maui.Controls.Internals.NameScope.SetNameScope(__root, nameScope0);
#line 1 "Test.xaml"
		bindingExtension0.Path = "Title";
#line default
		var xamlServiceProvider0 = new global::Microsoft.Maui.Controls.Xaml.Internals.XamlServiceProvider(this);
		var nsResolver0 = new global::Microsoft.Maui.Controls.Xaml.Internals.XmlNamespaceResolver();
		nsResolver0.Add("", "http://schemas.microsoft.com/dotnet/2021/maui");
		nsResolver0.Add("x", "http://schemas.microsoft.com/winfx/2009/xaml");
		xamlServiceProvider0.Add(typeof(global::Microsoft.Maui.Controls.Xaml.IXamlTypeResolver), new global::Microsoft.Maui.Controls.Xaml.Internals.XamlTypeResolver(nsResolver0, typeof(global::Test.TestPage).Assembly));
		global::Microsoft.Maui.Controls.BindingBase bindingBase0 = ((global::Microsoft.Maui.Controls.Xaml.IMarkupExtension<global::Microsoft.Maui.Controls.BindingBase>)bindingExtension0).ProvideValue(xamlServiceProvider0);
		__root.SetBinding(global::Microsoft.Maui.Controls.Page.TitleProperty, bindingBase0);
	}
}

""";

		var (result, generated) = RunGenerator(xaml, code);
		Assert.IsFalse(result.Diagnostics.Any());
		Assert.AreEqual(expected, generated);
	}
}